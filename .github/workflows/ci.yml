name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Plugins
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'  # LTS version (was incorrectly 25)

      - name: Validate JSON files
        run: |
          echo "Validating plugin.json files..."
          find . -name "plugin.json" -print0 | while IFS= read -r -d '' file; do
            echo "Checking $file..."
            jq . "$file" > /dev/null
          done

          echo "Validating .mcp.json files..."
          find . -name "*.mcp.json" -print0 | while IFS= read -r -d '' file; do
            echo "Checking $file..."
            jq . "$file" > /dev/null
          done

      - name: Lint shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
        continue-on-error: true

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_file: .yamllint.yml
        continue-on-error: true

      - name: Check SKILL.md files exist
        run: |
          echo "Checking for SKILL.md files..."
          SKILL_FILES=$(find . -name "SKILL.md" | wc -l)
          echo "Found $SKILL_FILES SKILL.md files"

          if [ "$SKILL_FILES" -eq 0 ]; then
            echo "::warning::No SKILL.md files found in repository"
          fi

      - name: Validate CHANGELOG.md
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "CHANGELOG.md exists"
          else
            echo "::warning::CHANGELOG.md not found"
          fi

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: '**/*.md'
        continue-on-error: true
