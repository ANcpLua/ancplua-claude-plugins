# Jules Code Review via API
#
# Uses the official Jules API (https://developers.google.com/jules/api)
# NOT a GitHub Action (no official action exists)
#
# Required secret: JULES_API_KEY
# Set at: Settings > Secrets > Actions > New repository secret

name: Jules Code Review

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Task for Jules (e.g., "Review PR #123 for security issues")'
        required: true
        type: string
      branch:
        description: 'Branch to work on'
        required: false
        default: 'main'
        type: string
      auto_pr:
        description: 'Auto-create PR when done'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  jules-task:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Validate API Key
        run: |
          if [ -z "${{ secrets.JULES_API_KEY }}" ]; then
            echo "::error::JULES_API_KEY secret is not set"
            echo "Set it at: Settings > Secrets > Actions > New repository secret"
            exit 1
          fi
          echo "✅ JULES_API_KEY is configured"

      - name: Create Jules Session
        id: jules
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          # Determine automation mode
          if [ "${{ inputs.auto_pr }}" = "true" ]; then
            AUTOMATION_MODE="AUTO_CREATE_PR"
          else
            AUTOMATION_MODE="AUTOMATION_MODE_UNSPECIFIED"
          fi

          # Create session via Jules API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            'https://jules.googleapis.com/v1alpha/sessions' \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Goog-Api-Key: $JULES_API_KEY" \
            -d "{
              \"prompt\": \"${{ inputs.prompt }}\",
              \"sourceContext\": {
                \"source\": \"sources/github/${{ github.repository }}\",
                \"githubRepoContext\": {
                  \"startingBranch\": \"${{ inputs.branch }}\"
                }
              },
              \"automationMode\": \"$AUTOMATION_MODE\",
              \"requirePlanApproval\": true,
              \"title\": \"GitHub Actions: ${{ inputs.prompt }}\"
            }")

          # Extract HTTP code and body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Jules API returned HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi

          # Extract session ID
          SESSION_ID=$(echo "$BODY" | jq -r '.id')
          SESSION_NAME=$(echo "$BODY" | jq -r '.name')

          echo "session_id=$SESSION_ID" >> "$GITHUB_OUTPUT"
          echo "session_name=$SESSION_NAME" >> "$GITHUB_OUTPUT"
          echo "✅ Jules session created: $SESSION_ID"

      - name: Post Session Link
        uses: actions/github-script@v7
        with:
          script: |
            const sessionId = '${{ steps.jules.outputs.session_id }}';
            const julesUrl = `https://jules.google/session/${sessionId}`;

            // Create an issue comment or workflow annotation
            core.notice(`Jules session created: ${julesUrl}`);

            // If this was triggered by a PR, comment on it
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Jules AI Task Started\n\n` +
                      `**Task:** ${{ inputs.prompt }}\n\n` +
                      `**Session:** [View in Jules](${julesUrl})\n\n` +
                      `Jules will analyze the code and create a plan. ` +
                      `Visit the link above to approve the plan and monitor progress.\n\n` +
                      `---\n*Triggered by GitHub Actions*`
              });
            }

      - name: Summary
        run: |
          {
            echo "## Jules Session Created"
            echo ""
            echo "- **Session ID:** ${{ steps.jules.outputs.session_id }}"
            echo "- **Task:** ${{ inputs.prompt }}"
            echo "- **Branch:** ${{ inputs.branch }}"
            echo "- **Auto PR:** ${{ inputs.auto_pr }}"
            echo ""
            echo "### Next Steps"
            echo ""
            echo "1. Visit [jules.google](https://jules.google) to view the session"
            echo "2. Review and approve the plan Jules generates"
            echo "3. Monitor progress and provide feedback if needed"
            echo "4. Review and merge the resulting PR"
          } >> "$GITHUB_STEP_SUMMARY"
