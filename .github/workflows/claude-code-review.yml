name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a Claude Code plugin marketplace repository.

            ## Project Context
            This is Alexander's Claude Code plugin marketplace and agent lab:
            - `.claude-plugin/marketplace.json` - plugin catalog
            - `plugins/` - individual plugins (autonomous-ci, smart-commit, code-review)
            - `skills/` - reusable Skills (SKILL.md files)
            - `agents/` - Agent SDK-based agents
            - `docs/` - specs, ADRs, architecture docs

            ## Review Focus

            **Plugin Schema Compliance**
            - `.claude-plugin/plugin.json` has required fields (name, version, description, author, repository, license)
            - Correct directory structure per Anthropic spec
            - `marketplace.json` validity and consistency

            **Skills & Commands**
            - `SKILL.md` files have clear trigger phrases
            - Command markdown files are well-structured
            - Skills follow activation patterns from docs

            **Documentation Sync**
            - Changes reflected in CHANGELOG.md
            - ADRs updated for architectural changes
            - README.md accuracy

            **Shell Scripts**
            - shellcheck compliance for `scripts/*.sh`
            - `local-validate.sh` coverage

            **Workflow Files**
            - actionlint compliance
            - Proper permissions and triggers

            **MCP Integration (if applicable)**
            - `.mcp.json` validity
            - Example configs in `docs/examples/` updated

            Use CLAUDE.md for project conventions. Post review via `gh pr comment`.

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'