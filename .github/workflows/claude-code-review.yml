name: Claude Code Review

on:
  pull_request:
    types: [ opened, synchronize, ready_for_review ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--model claude-opus-4-5-20251101'
          prompt: |
            You are performing a comprehensive code review for ancplua-claude-plugins.

            ## Repository Context
            - **Type A Repository**: Brain/orchestration - plugin definitions, skills, workflows
            - **Contents**: Markdown, JSON, Shell scripts, YAML workflows, .mcp.json configs
            - **FORBIDDEN**: C#/.NET code, absolute paths, secrets in files

            ## Review ALL of These Areas

            ### 1. Plugin Schema Compliance
            - Valid plugin.json structure
            - Required fields present (name, version, description)
            - Proper capability declarations

            ### 2. SKILL.md Quality
            - Clear workflow instructions
            - Proper step-by-step format
            - No phantom tool references

            ### 3. Shell Script Safety
            - shellcheck compliance
            - Proper quoting and error handling
            - No hardcoded paths or secrets

            ### 4. YAML Workflow Correctness
            - actionlint compliance
            - Proper permissions declared
            - Correct trigger configurations

            ### 5. Security
            - No secrets in files
            - No absolute paths
            - Input validation in scripts

            ### 6. Documentation
            - CHANGELOG updated for changes
            - README accurate
            - Clear usage instructions

            ## Your Task

            After analyzing the PR:

            1. Determine your verdict: APPROVE, REQUEST_CHANGES, or COMMENT
            2. Submit a formal GitHub review using:

            ```bash
            gh pr review ${{ github.event.pull_request.number }} \
              --approve|--request-changes|--comment \
              --body "## ðŸ¤– Claude Code Review (Opus 4.5)

            ### Summary
            [Brief description of what this PR does]

            ### Issues Found
            [List each issue with Location, Severity, Category, Description, and Fix]

            ### What's Good
            [Positive aspects of the PR]

            ---
            *Review performed per [CLAUDE.md](../blob/main/CLAUDE.md) guidelines*"
            ```

            Use --approve if changes look good, --request-changes if blocking issues found, --comment for suggestions.

      - name: Verify review was submitted
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Claude review completed for PR #${{ github.event.pull_request.number }}"